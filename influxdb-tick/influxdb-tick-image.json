{
    "min_packer_version": "0.12.0",
    "variables": {
        "aws_region": "us-east-1",
        "base_ami_name": "influxdb-enterprise",
        "influx_version": "1.7.3",
        "telegraf_version": "1.9.2"
      },
    "builders": [{
        "name": "influxdb-ami-ubuntu",
        "image": "Ubuntu 18.04",
        "ami_name": "{{user `base_ami_name`}}-amazon-linux-{{isotime | clean_ami_name}}",
        "ami_description": "An Amazon Linux 2 AMI that has InfluxDB Enterprise installed.",
        "instance_type": "t2.micro",
        "region": "{{user `aws_region`}}",
        "type": "amazon-ebs",
        "source_ami_filter": {
            "filters": {
            "virtualization-type": "hvm",
            "architecture": "x86_64",
            "name": "amzn2-ami-hvm-*-x86_64-gp2",
            "block-device-mapping.volume-type": "gp2",
            "root-device-type": "ebs"
            },
            "owners": ["amazon"],
            "most_recent": true
        },
        "ssh_username": "ec2-user"
    }],
    "provisioners": [{
        "type": "shell",
        "inline": [
            "sudo yum update -y",
            "sudo yum install -y jq polkit"
        ]
    },{
        "type": "file",
        "source": "{{template_dir}}/influxdb-data-1.7.3_9946d566ff9814bef9f491f32963b963ffebb8d7_c1.7.3_9946d566ff9814bef9f491f32963b963ffebb8d7.x86_64.rpm",
        "destination": "/tmp/influxdb-data-{{ user `influx_version` }}_c{{ user `influx_version` }}.x86_64.rpm"
    },{
        "type": "file",
        "source": "{{template_dir}}/influxdb-meta-1.7.3_9946d566ff9814bef9f491f32963b963ffebb8d7_c1.7.3_9946d566ff9814bef9f491f32963b963ffebb8d7.x86_64.rpm",
        "destination": "/tmp/influxdb-meta-{{ user `influx_version` }}_c{{ user `influx_version` }}.x86_64.rpm"
    },{
        "type": "shell",
        "inline": [
            "sudo yum -y localinstall /tmp/influxdb-data-{{ user `influx_version` }}_c{{ user `influx_version` }}.x86_64.rpm",
            "sudo systemctl disable influxdb.service"
        ]
    },{
        "type": "shell",
        "inline": [
            "sudo yum -y localinstall /tmp/influxdb-meta-{{ user `influx_version` }}_c{{ user `influx_version` }}.x86_64.rpm",
            "sudo systemctl disable influxdb-meta.service"
        ]
    },{
        "type": "shell",
        "inline": [
            "curl -u 3e7a50568acd655267e8e88d8ed17e2e5f237125: -H \"Content-Type: application/json\" \"https://27129-33258973-gh.circle-artifacts.com/0/build/linux/amd64/telegraf-1.10.0%7Ec55e1b5d-0.x86_64.rpm\" --output telegraf-{{ user `telegraf_version` }}-1.x86_64.rpm",
            "wget https://dl.influxdata.com/telegraf/releases/telegraf-{{ user `telegraf_version` }}-1.x86_64.rpm",
            "sudo yum -y localinstall telegraf-{{ user `telegraf_version` }}-1.x86_64.rpm",
            "sudo systemctl disable telegraf.service",
            "rm telegraf-{{ user `telegraf_version` }}-1.x86_64.rpm"
        ]
    },{
        "type": "file",
        "source": "{{template_dir}}/config/influxdb.conf",
        "destination": "/tmp/influxdb.conf"
    },{
        "type": "file",
        "source": "{{template_dir}}/config/influxdb-meta.conf",
        "destination": "/tmp/influxdb-meta.conf"
    },{
        "type": "file",
        "source": "{{template_dir}}/config/telegraf.conf",
        "destination": "/tmp/telegraf.conf"
    },{
        "type": "file",
        "source": "{{template_dir}}/scripts/setup.sh",
        "destination": "/tmp/setup.sh"
    },{
        "type": "shell",
        "inline": [
            "sudo mv /tmp/influxdb.conf /etc/influxdb/influxdb.conf",
            "sudo mv /tmp/influxdb-meta.conf /etc/influxdb/influxdb-meta.conf",
            "sudo mv /tmp/telegraf.conf /etc/telegraf/telegraf.conf",
            "sudo chown -R influxdb:influxdb /etc/influxdb",
            "sudo chown telegraf:telegraf /etc/telegraf",
            "sudo mkdir /opt/influxdb",
            "sudo mv /tmp/setup.sh /opt/influxdb/setup.sh"
        ]
    }]
}